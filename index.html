<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gen AI App</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="app">

    <!-- <button class="config-button" onclick="openConfigModal()">
      <span>DB Settings</span>
    </button> -->

    <h2>Ask your database</h2>

    <pre id="response"></pre>

    <div class="chat-input">
      <textarea id="question" placeholder="Ask a question..." rows="1" oninput="autoExpand(this)"></textarea>

      <button onclick="ask()">Ask</button>
    </div>

    <div class="disclaimer-banner">
      <p>
        <strong>Note:</strong> This AI-powered database assistant can make mistakes.
        Always verify critical queries & results.<br> For sensitive operations, consult your database administrator.
      </p>
    </div>

    <div class="db-controls">
      <button onclick="testConnection()">Test DB</button>
      <button onclick="viewSchema()">View Schema</button>
      <button onclick="clearResults()" class="btn-clear">Clear Results</button>
    </div>

    <div id="status" class="status-bar">
      <span id="ai_engine_status" class="status neutral">AI Agent: Checking...</span>
      <span class="separator"> | </span>
      <span id="dbStatus" class="status neutral">DB: Checking...</span>
    </div>

    <!-- AI Agent Toggle Switch -->
    <div class="ai-toggle-container">
      <div class="toggle-label">
        <span class="toggle-text">AI Agent</span>
        <label class="toggle-switch">
          <input type="checkbox" id="aiToggle" checked onchange="toggleAIAgent()">
          <span class="toggle-slider"></span>
        </label>
        <span class="toggle-status" id="aiToggleStatus">Enabled</span>
      </div>
    </div>

    <!-- Database Configuration Modal -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>
            <span class="status-indicator checking" id="configStatusIndicator"></span>
            Database Configuration
          </h3>
          <span class="close" onclick="closeConfigModal()">&times;</span>
        </div>

        <div class="alert alert-info">
          <span>Configure your SQL Server connection. You can paste a connection string from SQL Server Management
            Studio or enter details manually.</span>
        </div>

        <!-- Connection Mode Tabs -->
        <div class="connection-mode-tabs">
          <button class="tab-button active" onclick="switchTab('manual')" id="manualTab">
            Manual Entry
          </button>
          <button class="tab-button" onclick="switchTab('connectionString')" id="stringTab">
            Connection String
          </button>
        </div>

        <!-- Manual Entry Section -->
        <div id="manualSection">
          <div class="form-group">
            <label>Server Name / IP Address *</label>
            <input type="text" id="server" placeholder="localhost or DESKTOP-ABC\SQLEXPRESS or 192.168.1.100">
            <div class="help-text">Enter your SQL Server instance name, hostname, or IP address</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Database Name *</label>
              <input type="text" id="database" placeholder="e.g., sctcrb">
            </div>

            <div class="form-group">
              <label>Port (Optional)</label>
              <input type="text" id="port" placeholder="1234" value="1234">
            </div>
          </div>

          <div class="form-group">
            <label>Authentication Type *</label>
            <select id="authType" onchange="toggleAuthFields()">
              <option value="sql">SQL Server Authentication</option>
              <option value="windows">Windows Authentication (Trusted)</option>
            </select>
          </div>

          <div id="authFields">
            <div class="form-row">
              <div class="form-group">
                <label>Username *</label>
                <input type="text" id="username" placeholder="sa">
              </div>

              <div class="form-group">
                <label>Password *</label>
                <input type="password" id="password" placeholder="••••••••">
              </div>
            </div>
          </div>

          <div class="connection-preview" id="manualPreview" style="display: none;">
            <h4>Generated Connection String:</h4>
            <div class="connection-string-display" id="generatedString"></div>
          </div>
        </div>

        <!-- Connection String Section -->
        <div id="stringSection" style="display: none;">
          <div class="form-group">
            <label>Paste Connection String from SSMS *</label>
            <textarea id="connectionStringInput"
              placeholder="Server=myServerAddress;Database=myDataBase;User Id=myUsername;Password=myPassword;&#10;or&#10;Data Source=SERVER\INSTANCE;Initial Catalog=DATABASE;Integrated Security=True;"></textarea>
            <div class="help-text">
              Paste the connection string from SQL Server Management Studio. Common formats:<br>
              -> <strong> SQL Auth:</strong> Server=localhost;Database=mydb;User Id=sa;Password=pass;<br>
              -> <strong> Windows Auth:</strong> Server=localhost;Database=mydb;Integrated Security=True;
            </div>
          </div>

          <div class="connection-preview" id="stringPreview" style="display: none;">
            <h4>Parsed Connection Details:</h4>
            <div class="connection-string-display" id="parsedDetails"></div>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
          <button class="btn btn-success" onclick="testConnectionFromModal()">
            <span>Test Connection</span>
          </button>
          <button class="btn btn-primary" onclick="saveConfiguration()">
            <span>Save & Apply</span>
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>

    // Debug: Log when page loads
    console.log("Page loaded, initializing...");

    function autoExpand(el) {
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    }

    // Auto-expand textarea
    function autoExpand(el) {
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    }

    // Ask AI function
    async function ask() {
      const question = document.getElementById("question").value.trim();
      const responseEl = document.getElementById("response");

      if (!question) {
        responseEl.innerText = "Please enter a question";
        responseEl.className = "error";
        return;
      }

      responseEl.innerText = "Thinking...";
      responseEl.className = "";

      try {
        // Check if AI is enabled
        const aiEnabled = document.getElementById("aiToggle").checked;

        if (!aiEnabled) {
          responseEl.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #856404; background-color: #fff3cd; border-radius: 8px;">
        <strong>AI Agent is Disabled</strong>
        <p>Please enable the AI Agent toggle to generate SQL queries automatically.</p>
      </div>
    `;
          return;
        }

        const res = await fetch("api/ask.php", {
          method: "POST",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question: question,
            ai_enabled: aiEnabled
          })
        });

        const data = await res.json();

        // Display the result
        let displayText = "";

        if (data.error) {
          displayText = "ERROR:\n" + data.error +
            (data.details ? "\n\nDetails: " + data.details : "");
          responseEl.className = "error";
        } else {
          displayText = "GENERATED SQL:\n" + (data.sql || "N/A") +
            "\n\nRESULT:\n" + (data.answer || "No response");

          // Display data in table format if available
          if (data.data && data.data.length > 0) {
            displayText += "\n\nDATA:\n";
            displayText += JSON.stringify(data.data, null, 2);
          }
          responseEl.className = "success";
        }

        responseEl.innerText = displayText;

      } catch (error) {
        responseEl.innerText = "Network Error:\n" + error.message;
        responseEl.className = "error";
      }
    }

    // Check internet connectivity
    async function checkInternetConnection() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const response = await fetch('https://www.google.com/favicon.ico', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache',
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        return true;
      } catch (error) {
        console.log("No internet connection detected:", error);
        return false;
      }
    }

    // Toggle AI Agent with internet check
    async function toggleAIAgent() {
      const toggle = document.getElementById("aiToggle");
      const statusText = document.getElementById("aiToggleStatus");
      const aiStatusBar = document.getElementById("ai_engine_status");
      const isEnabled = toggle.checked;

      if (isEnabled) {
        // Show checking status
        statusText.textContent = "Checking...";
        statusText.classList.remove("enabled", "disabled");
        statusText.classList.add("disabled");

        const hasInternet = await checkInternetConnection();

        if (!hasInternet) {
          // No internet - revert toggle
          toggle.checked = false;
          statusText.textContent = "Disabled";
          statusText.classList.remove("enabled");
          statusText.classList.add("disabled");

          aiStatusBar.classList.remove("connected", "neutral");
          aiStatusBar.classList.add("disconnected");
          aiStatusBar.textContent = "AI Agent: No Internet";

          localStorage.setItem('ai_agent_enabled', 'false');
          showNotification("⚠️ Please connect to the internet first to enable AI Agent", "warning");
          return;
        }

        // Has internet - check AI service
        try {
          const res = await fetch("api/health_ai_engine.php");
          const data = await res.json();

          if (!data.ok) {
            toggle.checked = false;
            statusText.textContent = "Disabled";
            statusText.classList.remove("enabled");
            statusText.classList.add("disabled");

            aiStatusBar.classList.remove("connected", "neutral");
            aiStatusBar.classList.add("disconnected");
            aiStatusBar.textContent = "AI Agent: Service Unavailable";

            localStorage.setItem('ai_agent_enabled', 'false');
            showNotification("⚠️ AI service is not responding. Please try again later.", "warning");
            return;
          }
        } catch (error) {
          console.error("Error checking AI health:", error);
          toggle.checked = false;
          statusText.textContent = "Disabled";
          statusText.classList.remove("enabled");
          statusText.classList.add("disabled");

          aiStatusBar.classList.remove("connected", "neutral");
          aiStatusBar.classList.add("disconnected");
          aiStatusBar.textContent = "AI Agent: Connection Error";

          localStorage.setItem('ai_agent_enabled', 'false');
          showNotification("⚠️ Could not connect to AI service. Check your internet connection.", "warning");
          return;
        }
      }

      localStorage.setItem('ai_agent_enabled', isEnabled ? 'true' : 'false');
      statusText.classList.remove("enabled", "disabled");

      if (isEnabled) {
        statusText.textContent = "Enabled";
        statusText.classList.add("enabled");
        aiStatusBar.classList.remove("disconnected", "neutral");
        aiStatusBar.classList.add("connected");
        aiStatusBar.textContent = "AI Agent: Connected";
        showNotification("✅  AI Agent has been enabled. You can now ask questions!", "success");
      } else {
        statusText.textContent = "Disabled";
        statusText.classList.add("disabled");
        aiStatusBar.classList.remove("connected", "neutral");
        aiStatusBar.classList.add("disconnected");
        aiStatusBar.textContent = "AI Agent: Disabled";
        showNotification("⚠️  AI Agent has been disabled.", "warning");
      }
    }

    // Show notification helper function
    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;

      // Add to body
      document.body.appendChild(notification);

      // Trigger animation
      setTimeout(() => notification.classList.add('show'), 100);

      // Remove after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Load AI Agent state on page load
    function loadAIAgentState() {
      const savedState = localStorage.getItem('ai_agent_enabled');
      const toggle = document.getElementById("aiToggle");
      const statusText = document.getElementById("aiToggleStatus");

      // Default to enabled if no saved state
      const isEnabled = savedState === null ? true : savedState === 'true';

      toggle.checked = isEnabled;

      // Clear any existing classes first
      statusText.classList.remove("enabled", "disabled");

      if (isEnabled) {
        statusText.textContent = "Enabled";
        statusText.classList.add("enabled");
      } else {
        statusText.textContent = "Disabled";
        statusText.classList.add("disabled");
      }
    }

    // Test database connection
    function testConnection() {
      fetch("api/db_control.php?action=test")
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("Database connection successful!  : )");
          } else {
            alert("Database connection failed!\n\nDetails: " + (data.error || "Unknown error"));
          }
        })
        .catch(() => alert("Server not reachable"));
    }

    // View database schema
    async function viewSchema() {
      const responseEl = document.getElementById("response");
      responseEl.innerText = "Loading schema...";

      try {
        const res = await fetch("api/test_schema.php");
        const data = await res.json();

        if (data.success) {
          let schemaDisplay = `DATABASE SCHEMA
${data.table_count} tables found in 'sctcrb' database

${data.schema_text}

=> QUICK REFERENCE - Use these exact table names in your questions:
`;

          data.tables.forEach(t => {
            schemaDisplay += `\n• ${t.FullTableName}`;
          });

          schemaDisplay += `\n\n=> Example questions to try:
- "Show all data from sctcrb.tbl_members"
- "How many records in sctcrb.tbl_members?"
- "List top 10 rows from sctcrb.tbl_members"
- "Show me members invited"`;

          responseEl.innerText = schemaDisplay;
        } else {
          responseEl.innerText = "Error: " + data.error;
        }
      } catch (error) {
        responseEl.innerText = "Error fetching schema: " + error.message;
      }
    }

    // Clear Results
    function clearResults() {
      const responseEl = document.getElementById("response");
      const questionEl = document.getElementById("question");

      // Clear response area
      responseEl.innerText = "";
      responseEl.className = "";

      // Optionally clear the question input as well
      // questionEl.value = "";
      // questionEl.style.height = "auto";

      // Show confirmation notification
      showNotification("Results cleared successfully!", "info");
    }

    function updateStatus(el, isConnected, label) {
      el.classList.remove("connected", "disconnected", "neutral");

      if (isConnected) {
        el.classList.add("connected");
        el.innerText = label + ": Connected";
      } else {
        el.classList.add("disconnected");
        el.innerText = label + ": Not Connected";
      }
    }

    // Update status indicator
    function updateStatus(el, isConnected, label) {
      el.classList.remove("connected", "disconnected", "neutral");

      if (isConnected) {
        el.classList.add("connected");
        el.innerText = label + ": Connected";
      } else {
        el.classList.add("disconnected");
        el.innerText = label + ": Not Connected";
      }
    }

    // Check health status
    async function checkHealth() {
      const ai_engine = document.getElementById("ai_engine_status");
      const dbEl = document.getElementById("dbStatus");
      const toggle = document.getElementById("aiToggle");

      const aiEnabled = toggle ? toggle.checked : true;

      if (aiEnabled) {
        // Check internet first
        const hasInternet = await checkInternetConnection();

        if (!hasInternet) {
          updateStatus(ai_engine, false, "AI Agent");
          ai_engine.textContent = "AI Agent: No Internet";

          // Auto-disable toggle if internet is lost
          if (toggle.checked) {
            toggle.checked = false;
            const statusText = document.getElementById("aiToggleStatus");
            statusText.textContent = "Disabled";
            statusText.classList.remove("enabled");
            statusText.classList.add("disabled");
            localStorage.setItem('ai_agent_enabled', 'false');
          }
        } else {
          try {
            const res = await fetch("api/health_ai_engine.php");
            const data = await res.json();
            console.log("AI Engine response:", data);
            updateStatus(ai_engine, data.ok === true, "AI Agent");

            if (!data.ok && toggle.checked) {
              toggle.checked = false;
              const statusText = document.getElementById("aiToggleStatus");
              statusText.textContent = "Disabled";
              statusText.classList.remove("enabled");
              statusText.classList.add("disabled");
              localStorage.setItem('ai_agent_enabled', 'false');
            }
          } catch (error) {
            console.error("AI Engine error:", error);
            updateStatus(ai_engine, false, "AI Agent");

            if (toggle.checked) {
              toggle.checked = false;
              const statusText = document.getElementById("aiToggleStatus");
              statusText.textContent = "Disabled";
              statusText.classList.remove("enabled");
              statusText.classList.add("disabled");
              localStorage.setItem('ai_agent_enabled', 'false');
            }
          }
        }
      } else {
        ai_engine.classList.remove("connected", "neutral");
        ai_engine.classList.add("disconnected");
        ai_engine.textContent = "AI Agent: Disabled";
      }

      // Check database status
      try {
        const res2 = await fetch("api/health_db.php");
        const dbData = await res2.json();
        console.log("DB response:", dbData);
        updateStatus(dbEl, dbData.ok === true, "DB");
      } catch (error) {
        console.error("DB error:", error);
        updateStatus(dbEl, false, "DB");
      }
    }

    // Modal functions
    function openConfigModal() {
      document.getElementById("configModal").style.display = "block";
      loadSavedConfiguration();
    }

    function closeConfigModal() {
      document.getElementById("configModal").style.display = "none";
    }

    // Switch between tabs
    function switchTab(mode) {
      const manualTab = document.getElementById("manualTab");
      const stringTab = document.getElementById("stringTab");
      const manualSection = document.getElementById("manualSection");
      const stringSection = document.getElementById("stringSection");

      if (mode === 'manual') {
        manualTab.classList.add("active");
        stringTab.classList.remove("active");
        manualSection.style.display = "block";
        stringSection.style.display = "none";
      } else {
        stringTab.classList.add("active");
        manualTab.classList.remove("active");
        stringSection.style.display = "block";
        manualSection.style.display = "none";
      }
    }

    // Toggle authentication fields
    function toggleAuthFields() {
      const authType = document.getElementById("authType").value;
      const authFields = document.getElementById("authFields");

      if (authType === "windows") {
        authFields.style.display = "none";
      } else {
        authFields.style.display = "block";
      }

      updatePreview();
    }

    // Update connection string preview
    function updatePreview() {
      const server = document.getElementById("server").value;
      const database = document.getElementById("database").value;
      const authType = document.getElementById("authType").value;
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      if (server || database) {
        let connString = "";

        if (authType === "windows") {
          connString = `Server=${server};Database=${database};Integrated Security=True;`;
        } else {
          connString = `Server=${server};Database=${database};User Id=${username};Password=${password};`;
        }

        document.getElementById("generatedString").textContent = connString;
        document.getElementById("manualPreview").style.display = "block";
      } else {
        document.getElementById("manualPreview").style.display = "none";
      }
    }

    // Parse and display connection string
    function parseConnectionString() {
      const connString = document.getElementById("connectionStringInput").value.trim();

      if (!connString) {
        document.getElementById("stringPreview").style.display = "none";
        return;
      }

      const params = {};
      connString.split(';').forEach(part => {
        const [key, value] = part.split('=').map(s => s.trim());
        if (key && value) {
          params[key.toLowerCase()] = value;
        }
      });

      let details = "";
      details += `Server: ${params['server'] || params['data source'] || 'Not specified'}\n`;
      details += `Database: ${params['database'] || params['initial catalog'] || 'Not specified'}\n`;

      if (params['integrated security'] === 'True' || params['integrated security'] === 'SSPI') {
        details += `Authentication: Windows Authentication`;
      } else {
        details += `Authentication: SQL Server Authentication\n`;
        details += `Username: ${params['user id'] || params['uid'] || 'Not specified'}`;
      }

      document.getElementById("parsedDetails").textContent = details;
      document.getElementById("stringPreview").style.display = "block";
    }

    // Add event listeners for live preview
    document.addEventListener('DOMContentLoaded', function () {
      ['server', 'database', 'username', 'password'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updatePreview);
        }
      });

      const connStringInput = document.getElementById("connectionStringInput");
      if (connStringInput) {
        connStringInput.addEventListener('input', parseConnectionString);
      }
    });

    // Test connection from modal
    async function testConnectionFromModal() {
      const config = getCurrentConfiguration();

      if (!validateConfiguration(config)) {
        alert("Please fill in all required fields!");
        return;
      }

      // Save temporarily
      localStorage.setItem('db_config', JSON.stringify(config));

      try {
        const res = await fetch("api/db_control.php?action=test");
        const data = await res.json();

        if (data.success) {
          alert("Connection successful!\n\nYour database is reachable and ready to use.");
          document.getElementById("configStatusIndicator").classList.remove("inactive", "checking");
          document.getElementById("configStatusIndicator").classList.add("active");
        } else {
          alert("Connection failed!\n\nError: " + (data.error || "Unknown error") + "\n\nPlease check your connection details.");
          document.getElementById("configStatusIndicator").classList.remove("active", "checking");
          document.getElementById("configStatusIndicator").classList.add("inactive");
        }
      } catch (error) {
        alert("Server error!\n\n" + error.message);
      }
    }

    // Get current configuration
    function getCurrentConfiguration() {
      const manualSection = document.getElementById("manualSection");
      const isManualMode = manualSection.style.display !== "none";

      if (isManualMode) {
        const authType = document.getElementById("authType").value;
        return {
          mode: 'manual',
          server: document.getElementById("server").value,
          database: document.getElementById("database").value,
          port: document.getElementById("port").value,
          authType: authType,
          username: authType === 'sql' ? document.getElementById("username").value : '',
          password: authType === 'sql' ? document.getElementById("password").value : ''
        };
      } else {
        return {
          mode: 'connectionString',
          connectionString: document.getElementById("connectionStringInput").value
        };
      }
    }

    // Validate configuration
    function validateConfiguration(config) {
      if (config.mode === 'manual') {
        if (!config.server || !config.database) return false;
        if (config.authType === 'sql' && (!config.username || !config.password)) return false;
      } else {
        if (!config.connectionString) return false;
      }
      return true;
    }

    // Save configuration
    function saveConfiguration() {
      const config = getCurrentConfiguration();

      if (!validateConfiguration(config)) {
        alert("Please fill in all required fields!");
        return;
      }

      localStorage.setItem('db_config', JSON.stringify(config));

      alert("Configuration saved successfully!\n\nNote: You'll need to update your db.php file on the server with these connection details.");

      closeConfigModal();
      checkHealth();
    }

    // Load saved configuration
    function loadSavedConfiguration() {
      const saved = localStorage.getItem('db_config');
      if (!saved) return;

      try {
        const config = JSON.parse(saved);

        if (config.mode === 'manual') {
          switchTab('manual');
          document.getElementById("server").value = config.server || '';
          document.getElementById("database").value = config.database || '';
          document.getElementById("port").value = config.port || '1433';
          document.getElementById("authType").value = config.authType || 'sql';
          document.getElementById("username").value = config.username || '';
          document.getElementById("password").value = config.password || '';
          toggleAuthFields();
          updatePreview();
        } else {
          switchTab('connectionString');
          document.getElementById("connectionStringInput").value = config.connectionString || '';
          parseConnectionString();
        }
      } catch (error) {
        console.error("Error loading configuration:", error);
      }
    }

    // Run immediately on page load
    console.log("Starting health checks every 30 seconds...");
    loadAIAgentState();
    checkHealth();

    // Run every 30 seconds
    setInterval(checkHealth, 30000);

  </script>

</body>

</html>